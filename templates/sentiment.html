<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>팬 감성 분석</title>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background:#f6f7fa; margin:40px 0; }
    body.embed { margin:10px 0; background:transparent; }

    .selector-wrap{ display:flex; justify-content:center; margin-bottom:18px; }
    select{ font-size:18px; width:220px; height:44px; }

    .fan-card{
      max-width:720px; margin:0 auto; background:#fff; border-radius:24px;
      box-shadow:0 10px 36px rgba(0,0,0,.08); padding:24px; position:relative;
    }
    .fan-header{ display:flex; align-items:center; gap:14px; margin-bottom:10px; }
    .fan-header img{ width:56px; height:56px; border-radius:50%; }
    .team-title{ font-weight:900; font-size:22px; }
    .headline{ color:#333; margin-top:2px; }

    .comments-box{
      background:#f9fbff; border:1px solid #e9f0ff;
      border-radius:14px; padding:12px 14px; margin:10px 0 14px;
    }
    .cmt{ padding:8px 10px; margin:6px 0; border-radius:10px; background:#fff; border:1px solid #eef2f7; }
    .cmt b{ color:#111; }

    .btns{ display:flex; gap:10px; }
    .btn{ flex:1; padding:12px 0; border-radius:12px; background:#eef3ff; border:1px solid #dfe7ff; font-weight:700; cursor:pointer; }

    .thermo-row{ display:flex; align-items:center; gap:22px; justify-content:center; margin-top:6px; }
    #big-thermo-svg{ display:block; }
    .thermo-info{ display:flex; flex-direction:column; align-items:flex-start; }
    .thermo-val{ font-size:34px; font-weight:900; color:#ff5a36; }
    .thermo-cmt{ font-size:16px; font-weight:800; color:#222; margin-top:6px; }
  </style>
</head>
<body>
  <div class="selector-wrap">
    <select id="team-select" onchange="onTeamChange()">
      <option value="">구단을 선택하세요</option>
      {% for team in team_list %}<option value="{{ team }}">{{ team }}</option>{% endfor %}
    </select>
  </div>

  <div class="fan-card" id="team-info-card" style="display:none;">
    <div class="fan-header">
      <img id="team-logo" src="" alt="logo" />
      <div>
        <div id="team-name" class="team-title"></div>
        <div id="headline" class="headline"></div>
      </div>
    </div>

    <div class="comments-box" id="comments-box" style="display:none;">
      <div id="comments-list"></div>
      <div class="btns">
        <button id="more-btn" class="btn" onclick="showMore()" style="display:none;">여론 더보기</button>
        <button id="less-btn" class="btn" onclick="showLess()" style="display:none;">간단히 보기</button>
      </div>
    </div>

    <div class="thermo-row">
      <svg id="big-thermo-svg" width="84" height="150" viewBox="0 0 80 140">
        <rect x="30" y="15" width="20" height="70" rx="10" fill="#f6f7fa" stroke="#bbb" stroke-width="4"/>
        <circle cx="40" cy="95" r="20" fill="#f6f7fa" stroke="#bbb" stroke-width="4"/>
        <rect id="big-thermo-bar" x="30" y="15" width="20" height="0" rx="10" fill="#4fc3f7"/>
        <circle id="big-thermo-bulb" cx="40" cy="95" r="16" fill="#4fc3f7"/>
      </svg>
      <div class="thermo-info">
        <div class="thermo-val" id="big-thermo-value">0%</div>
        <div class="thermo-cmt" id="big-thermo-comment">팀을 선택하세요</div>
      </div>
    </div>
  </div>

<script>
  const initialTeamFromServer = "{{ initial_team|default('') }}";
  const isEmbed = "{{ embed|default('0') }}" === "1";
  if (isEmbed) document.body.classList.add('embed');

  let allComments = [];
  let lastData = null;

  const teamFullNames = {
    '롯데':'롯데 자이언츠','NC':'NC 다이노스','한화':'한화 이글스','삼성':'삼성 라이온즈',
    '두산':'두산 베어스','키움':'키움 히어로즈','LG':'LG 트윈스','SSG':'SSG 랜더스',
    'KT':'KT 위즈','KIA':'기아 타이거즈'
  };

  function updateThermo(t, msg){
    const bar = document.getElementById('big-thermo-bar');
    const bulb = document.getElementById('big-thermo-bulb');
    const val = document.getElementById('big-thermo-value');
    const cmt = document.getElementById('big-thermo-comment');
    const maxH=70, y0=15; const temp = Math.max(0, Math.min(100, Number(t)||0));
    const h = Math.round(maxH*(temp/100));
    bar.setAttribute('height', h); bar.setAttribute('y', y0+maxH-h);
    const color = temp>=80 ? '#ff5a36' : temp>=40 ? '#ffd600' : '#4fc3f7';
    bar.setAttribute('fill', color); bulb.setAttribute('fill', color);
    val.textContent = temp+'%'; cmt.textContent = msg||'';
  }

  function renderComments(showCount){
    const box = document.getElementById('comments-box');
    const list = document.getElementById('comments-list');
    if (!allComments.length){ box.style.display='none'; return; }
    box.style.display='block';
    let html='';
    for (let i=0;i<Math.min(showCount, allComments.length);i++){
      const id = (allComments[i].id||'').trim() || '익명';
      html += `<div class="cmt"><b>@${id}</b> ${allComments[i].comment||''}</div>`;
    }
    list.innerHTML = html;
    const more = document.getElementById('more-btn');
    const less = document.getElementById('less-btn');
    if (showCount < allComments.length){ more.style.display='block'; less.style.display='none'; }
    else if (allComments.length>3){ more.style.display='none'; less.style.display='block'; }
    else { more.style.display='none'; less.style.display='none'; }

    if (isEmbed && window.parent){
      setTimeout(()=>{
        const h = document.documentElement.scrollHeight || document.body.scrollHeight || 560;
        window.parent.postMessage({type:'resize-sentiment-iframe', height:h}, '*');
      }, 30);
    }
  }

  function renderCard(data, initialCount=3){
    lastData = data;
    document.getElementById('team-info-card').style.display='block';
    document.getElementById('team-logo').src = data.logo_path||'';
    document.getElementById('team-name').innerText = teamFullNames[data.team] || data.team || '';
    document.getElementById('headline').innerText = data.headline || '';
    allComments = data.comments || [];
    renderComments(initialCount);
    updateThermo(data.temperature, data.temp_comment);
  }

  function showMore(){ renderComments(10); }
  function showLess(){ renderComments(3); }

  function onTeamChange(){
    const team = document.getElementById('team-select').value;
    if (!team){ document.getElementById('team-info-card').style.display='none'; return; }
    fetch(`/api/teaminfo?team=${encodeURIComponent(team)}&count=10`)
      .then(r=>r.json()).then(d=>renderCard(d,3))
      .catch(()=>{});
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    const sel = document.getElementById('team-select');
    const urlTeam = new URLSearchParams(window.location.search).get('team');
    const t = urlTeam || initialTeamFromServer;
    if (t){
      const opt = [...sel.options].find(o => o.value === t);
      if (opt){ sel.value = t; onTeamChange(); }
    }
  });
</script>
</body>
</html>
