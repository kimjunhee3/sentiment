<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>팬 감성 분석</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f3f4f6}
    .wrap{max-width:640px;margin:24px auto;padding:0 16px}
    .selector{display:flex;justify-content:center;margin-bottom:12px}
    .selector select{padding:8px 12px;border-radius:8px;border:1px solid #d0d7e2;background:#fff}

    .fan-card{
      background:#fff;border-radius:22px;box-shadow:0 4px 24px #0001;
      margin:0 auto;padding:20px 20px 16px 20px;
      display:flex;flex-direction:column;overflow:hidden
    }
    .fan-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .fan-header img{width:48px;height:48px;border-radius:50%;object-fit:contain;background:#fff}
    .fan-title{font-weight:bold;font-size:1.25em;text-align:center;width:100%}
    .fan-sub{color:#222;font-size:.95em;margin-top:4px;text-align:center}

    .fan-comments{background:#f8fafd;border-radius:12px;padding:12px 14px;margin:12px 0;font-size:.95em;max-height:180px;overflow:auto}
    .fan-comment{padding:4px 0;font-size:.92em;color:#222}
    .nickname{
      background:linear-gradient(135deg,#FFE5E5,#E5F3FF,#F0E5FF,#E5FFE5);
      background-size:300% 300%;animation:gradientShift 3s ease infinite;
      padding:2px 8px;border-radius:12px;font-weight:bold;display:inline-block;margin-right:6px;color:#444;box-shadow:0 1px 3px rgba(0,0,0,.1)
    }
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    #comment-btns{display:flex;gap:8px;margin-bottom:6px}
    #more-btn,#less-btn{flex:1;background:#f5f7fa;border:1.5px solid #e0e6ef;border-radius:16px;padding:8px 0;cursor:pointer;font-weight:bold;color:#222;font-size:.9em}
    #more-btn:hover,#less-btn:hover{background:#e6f0ff}

    .big-thermo-row{display:flex;align-items:center;gap:20px;margin:8px auto 0 auto;justify-content:center}
    #big-thermo-svg{display:block}
    .big-thermo-info{display:flex;flex-direction:column;align-items:flex-start}
    .big-thermo-value{font-size:2.1em;font-weight:800;color:#ff5a36;margin-bottom:6px}
    .big-thermo-comment{font-size:1.05em;font-weight:700;color:#222}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ✅ 상단 구단 선택 드롭다운 -->
    <div class="selector">
      <select id="team-select" aria-label="구단 선택"></select>
    </div>

    <div class="fan-card" id="team-info-card" style="display:none;">
      <div class="fan-header">
        <img id="team-logo" src="" alt="구단로고"/>
        <div style="flex:1">
          <div id="team-name" class="fan-title"></div>
          <div id="headline" class="fan-sub"></div>
        </div>
      </div>

      <div class="fan-comments" id="comments-list"></div>
      <div id="comment-btns">
        <button id="more-btn" onclick="showMore()" style="display:none;">여론 더보기</button>
        <button id="less-btn" onclick="showLess()" style="display:none;">간단히 보기</button>
      </div>

      <div class="big-thermo-row">
        <svg id="big-thermo-svg" width="80" height="140" viewBox="0 0 80 140">
          <rect x="30" y="15" width="20" height="70" rx="10" fill="#f6f7fa" stroke="#bbb" stroke-width="4"/>
          <circle cx="40" cy="95" r="20" fill="#f6f7fa" stroke="#bbb" stroke-width="4"/>
          <rect id="big-thermo-bar" x="30" y="15" width="20" height="0" rx="10" fill="#4fc3f7"/>
          <circle id="big-thermo-bulb" cx="40" cy="95" r="16" fill="#4fc3f7"/>
        </svg>
        <div class="big-thermo-info">
          <div class="big-thermo-value" id="big-thermo-value">0%</div>
          <div class="big-thermo-comment" id="big-thermo-comment"></div>
        </div>
      </div>
    </div>
  </div>

<script>
let allComments=[]; let lastTeamData={};
const teamFullNames={ '롯데':'롯데 자이언츠','NC':'NC 다이노스','한화':'한화 이글스','삼성':'삼성 라이온즈','두산':'두산 베어스','키움':'키움 히어로즈','LG':'LG 트윈스','SSG':'SSG 랜더스','KT':'KT 위즈','KIA':'기아 타이거즈' };

function updateBigThermo(temp,msg){
  const bar=document.getElementById('big-thermo-bar');
  const bulb=document.getElementById('big-thermo-bulb');
  const value=document.getElementById('big-thermo-value');
  const comment=document.getElementById('big-thermo-comment');
  const maxH=70, y0=15, h=Math.round(maxH*(temp/100));
  bar.setAttribute('height',h); bar.setAttribute('y',y0+maxH-h);
  const color=temp>=80?'#ff5a36':(temp>=40?'#ffd600':'#4fc3f7');
  bar.setAttribute('fill',color); bulb.setAttribute('fill',color);
  value.textContent=temp+'%'; comment.textContent=msg;
}

function postHeight(){
  const h=document.body.scrollHeight;
  try{ window.parent.postMessage({type:'resize-sentiment', height:h}, '*'); }catch(e){}
}

function renderTeamInfo(data, showCount){
  document.getElementById('team-info-card').style.display='block';
  const logoEl = document.getElementById('team-logo');
  logoEl.src = data.logo_path || '';
  logoEl.alt = `${data.team} 로고`;
  document.getElementById('team-name').innerText=teamFullNames[data.team]||data.team;
  document.getElementById('headline').innerText=data.headline||'';

  allComments=data.comments||[];
  let html='';
  for(let i=0;i<Math.min(showCount, allComments.length);i++){
    const id=(allComments[i].id||'').trim()||'익명';
    html+=`<div class="fan-comment"><span class="nickname">${id}</span> ${allComments[i].comment}</div>`;
  }
  document.getElementById('comments-list').innerHTML=html;

  const moreBtn=document.getElementById('more-btn');
  const lessBtn=document.getElementById('less-btn');
  if(showCount<allComments.length){ moreBtn.style.display='block'; lessBtn.style.display='none'; }
  else if(allComments.length>3){ moreBtn.style.display='none'; lessBtn.style.display='block'; }
  else { moreBtn.style.display='none'; lessBtn.style.display='none'; }

  updateBigThermo(data.temperature, data.temp_comment);
  setTimeout(postHeight, 0);
}

function showMore(){ renderTeamInfo(lastTeamData, 10); }
function showLess(){ renderTeamInfo(lastTeamData, 3); }

function loadTeam(team){
  const url = `/api/teaminfo?team=${encodeURIComponent(team)}&count=10`;
  fetch(url)
    .then(r=>r.json())
    .then(d=>{ lastTeamData=d; renderTeamInfo(d,3); });
}

function setSelectAndURL(team){
  const sel = document.getElementById('team-select');
  if (sel && sel.value !== team) sel.value = team;
  const sp = new URLSearchParams(location.search);
  sp.set('team', team);
  history.replaceState({}, '', `${location.pathname}?${sp.toString()}`);
}

window.addEventListener('DOMContentLoaded', async ()=>{
  // 팀 리스트 채우기
  const meta = await fetch('/api/teams').then(r=>r.json()).catch(()=>({teams:[], default:'SSG'}));
  const sel = document.getElementById('team-select');
  sel.innerHTML = meta.teams.map(t=>`<option value="${t}">${t}</option>`).join('');

  const urlTeam=new URLSearchParams(location.search).get('team') || meta.default || 'SSG';
  setSelectAndURL(urlTeam);
  loadTeam(urlTeam);

  sel.addEventListener('change', (e)=>{
    const t = e.target.value;
    setSelectAndURL(t);
    loadTeam(t);
  });
});
</script>
</body>
</html>
